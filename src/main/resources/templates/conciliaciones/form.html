<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

<head>
    <title>Conciliación Bancaria :: SG - SUDAMERICANA</title>
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- jQuery UI -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    
    <!-- CSRF Token -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    
    <style>
        .main-content { padding: 0; }
        .control-label { display: block; }
        .rowCenter {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .container { position: relative; }
        .ui-datepicker-calendar { display: none; }
        
        .input-file-container { position: relative; }
        .custom-file-upload {
            border: 1px solid #ccc;
            display: inline-block;
            padding: 6px 12px;
            cursor: pointer;
            background-color: #f8f9fa;
            border-radius: 4px;
            width: 100%;
            text-align: left;
        }
        #file-upload-name { margin-left: 10px; }
        
        .table-fixed-header {
            height: 450px;
            overflow-y: auto;
        }
        .table-fixed-detail {
            height: 250px;
            overflow-y: auto;
        }
        
        /* Estilos para tooltips */
        .tooltip-inner {
            max-width: 200px;
            padding: 6px 8px;
            color: #fff;
            background-color: #333;
            border-radius: 4px;
        }
        
        /* Mejoras visuales */
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        .table thead th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .step-indicator {
            display: flex;
            margin-bottom: 20px;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            position: relative;
        }
        .step:not(:last-child):after {
            content: "";
            position: absolute;
            top: 50%;
            right: 0;
            width: 100%;
            height: 2px;
            background-color: #ccc;
            z-index: 1;
        }
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            position: relative;
            z-index: 2;
        }
        .step.active .step-icon {
            background-color: #007bff;
            color: white;
        }
        .step.completed .step-icon {
            background-color: #28a745;
            color: white;
        }
        
        /* Highlight para las filas de la tabla */
        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <div th:insert="~{fragments/navbar :: navbar}"></div>

    <div class="container-fluid mt-4">
        <div class="card shadow-sm">
            <div class="card-header position-relative">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="fw-bold mb-0">Conciliación Bancaria - Generador de Reportes</h2>
                    <div>
                        <button id="btnBuscar" type="button" class="btn btn-sm btn-primary" title="Buscar">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <button id="btnActualizar" type="button" class="btn btn-sm btn-info text-white" title="Actualizar datos">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Indicador de pasos -->
            <div class="card-body pb-0">
                <div class="step-indicator">
                    <div class="step" th:classappend="${not #lists.isEmpty(grillaRegistro) ? 'completed' : ''}">
                        <div class="step-icon">
                            <i class="fas fa-file-excel"></i>
                        </div>
                        <div class="step-text">1. Cargar Datos Bancarios</div>
                    </div>
                    <div class="step" th:classappend="${estadoBanco != null && estadoBanco.estado > 0 ? 'completed' : ''}">
                        <div class="step-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="step-text">2. Ejecutar Conciliación</div>
                    </div>
                    <div class="step" th:classappend="${estadoBanco != null && estadoBanco.estado == 42 ? 'completed' : ''}">
                        <div class="step-icon">
                            <i class="fas fa-download"></i>
                        </div>
                        <div class="step-text">3. Descargar Reporte</div>
                    </div>
                </div>
            </div>
            
            <div class="card-body">
                <form id="formularioConciliacion" th:action="@{/conciliaciones/buscar}" method="post">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="cbEntidad" class="control-label fw-bold">Entidad Bancaria:</label>
                                        <select id="cbEntidad" name="codigoEntidad" class="form-select" 
                                                th:value="${codigoEntidad}">
                                            <option th:each="entidad : ${lstEntidad}" 
                                                    th:value="${entidad.entidad}" 
                                                    th:text="${entidad.descripcion}"
                                                    th:selected="${entidad.entidad == codigoEntidad}">
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="cbCuenta" class="control-label fw-bold">Cuenta Corriente:</label>
                                        <select id="cbCuenta" name="nroCuenta" class="form-select">
                                            <option th:each="cuenta : ${listaCta}" 
                                                    th:value="${cuenta.nrocta}" 
                                                    th:text="${cuenta.descrip}"
                                                    th:selected="${cuenta.nrocta == nroCuenta}">
                                            </option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label for="month" class="control-label fw-bold">Periodo (Mes/Año):</label>
                                        <div class="input-group">
                                            <input type="text" id="month" name="fechaMesAnio" class="form-control" 
                                                   th:value="${fechaMesAnio}" placeholder="MM/YYYY" />
                                            <span class="input-group-text">
                                                <i class="fas fa-calendar-alt"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="form-group mb-3">
                                        <label for="txtEstadoBanco" class="control-label fw-bold">Estado de Transacciones:</label>
                                        <div class="input-group">
                                            <input type="text" id="txtEstadoBanco" class="form-control" 
                                                   th:value="${not #lists.isEmpty(grillaRegistro) ? 
                                                   'Datos cargados (' + #lists.size(grillaRegistro) + ' transacciones)' : 
                                                   'Sin datos cargados'}" readonly />
                                            <span class="input-group-text" th:classappend="${not #lists.isEmpty(grillaRegistro) ? 'bg-success text-white' : 'bg-warning text-dark'}">
                                                <i class="fas" th:classappend="${not #lists.isEmpty(grillaRegistro) ? 'fa-check' : 'fa-exclamation-triangle'}"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-md-7">
                                    <div class="form-group mb-3">
                                        <label class="control-label fw-bold">Adjuntar Estado de Cuenta Bancario:</label>
                                        <div class="input-file-container">
                                            <label for="fileInput" class="custom-file-upload">
                                                <i class="fas fa-cloud-upload-alt"></i> Seleccionar archivo Excel
                                                <span id="file-upload-name"></span>
                                            </label>
                                            <input id="fileInput" type="file" style="display:none;"
                                                   accept=".xls,.xlsx" />
                                        </div>
                                        <small class="form-text text-muted">Formato requerido: Excel con transacciones bancarias</small>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <label class="control-label fw-bold">Resumen Financiero:</label>
                                    <div class="card">
                                        <div class="card-body p-0">
                                            <div class="table-fixed-detail">
                                                <table class="table table-bordered table-sm mb-0">
                                                    <thead>
                                                        <tr class="table-secondary">
                                                            <th>Concepto</th>
                                                            <th class="text-end">Monto</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr th:each="detalle : ${grillaDetalle}">
                                                            <td th:text="${detalle.concepto}"></td>
                                                            <td class="text-end" th:text="${#numbers.formatDecimal(detalle.monto, 1, 'COMMA', 2, 'POINT')}"></td>
                                                        </tr>
                                                        <tr th:if="${#lists.isEmpty(grillaDetalle)}">
                                                            <td colspan="2" class="text-center">No hay datos disponibles</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="mb-0">Transacciones Cargadas del Banco</h4>
                            <div>
                                <!--
                                <button id="btnProcesar" type="button" class="btn btn-warning me-2" 
                                        title="Ejecutar proceso de conciliación">
                                    <i class="fas fa-bolt"></i> Procesar Conciliación
                                </button>
                            -->
                                <button id="btnExportar" class="btn btn-success" onclick="exportarExcel()">
                                    <i class="fas fa-file-excel"></i> Procesar y Exportar
                                </button>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Esta tabla muestra las transacciones bancarias cargadas desde el archivo Excel. Para generar la conciliación
                            con los datos de Navasoft, haga clic en "Procesar Conciliación" y luego descargue el informe completo.
                        </div>
                        
                        <div class="table-fixed-header border">
                            <table id="tablaRegistros" class="table table-bordered table-hover table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th style="width: 10%">Fecha</th>
                                        <th style="width: 30%">Descripción</th>
                                        <th style="width: 15%">Nro. Operación</th>
                                        <th style="width: 10%">Hora Op.</th>
                                        <th style="width: 15%" class="text-end">Monto</th>
                                        <th style="width: 20%">Referencias</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="registro : ${grillaRegistro}">
                                        <td th:text="${#temporals.format(registro.fecha, 'dd/MM/yyyy')}"></td>
                                        <td th:text="${registro.descripcion}"></td>
                                        <td th:text="${registro.operacionNro}"></td>
                                        <td th:text="${registro.operacionHora}"></td>
                                        <td class="text-end" th:text="${#numbers.formatDecimal(registro.monto, 1, 'COMMA', 2, 'POINT')}"></td>
                                        <td th:text="${registro.referencia}"></td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(grillaRegistro)}">
                                        <td colspan="6" class="text-center">
                                            <div class="p-3">
                                                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                                No hay transacciones cargadas para este periodo. Por favor, suba un archivo de extracto bancario.
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
     <!-- Footer -->
     <footer class="bg-dark text-white text-center py-3 mt-5">
        <p class="mb-0">&copy; 2025 Sudamericana. Todos los derechos reservados.</p>
    </footer>
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Token CSRF para peticiones AJAX
        const token = $("meta[name='_csrf']").attr("content");
        const header = $("meta[name='_csrf_header']").attr("content");
        
        $(document).ready(function() {
            // Inicializar tooltips de Bootstrap
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });
            
            // Configuración del datepicker para selección de mes/año
            $('#month').datepicker({
                changeMonth: true,
                changeYear: true,
                showButtonPanel: true,
                dateFormat: 'mm/yy',
                onClose: function(dateText, inst) { 
                    var month = $("#ui-datepicker-div .ui-datepicker-month :selected").val();
                    var year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
                    $(this).datepicker('setDate', new Date(year, month, 1));
                }
            });
            
            // Mostrar nombre del archivo seleccionado
            $('#fileInput').change(function() {
                var fileName = $(this).val().split('\\').pop();
                $('#file-upload-name').text(fileName ? fileName : '');
            });
            
            // Botón de búsqueda
            $('#btnBuscar').click(function() {
                $('#formularioConciliacion').submit();
            });
            
            // Manejo de carga de archivo Excel
            $('#fileInput').change(function(e) {
                if (e.target.files.length > 0) {
                    if (confirm('¿Está seguro de cargar el archivo? Esto importará las transacciones bancarias.')) {
                        uploadFile(e.target.files[0]);
                    } else {
                        // Reset file input
                        $(this).val('');
                        $('#file-upload-name').text('');
                    }
                }
            });
            
            // Botón de procesamiento automático de conciliación
            $('#btnProcesar').click(function() {
                procesarConciliacionAutomatica();
            });
            
            // Botón para refrescar datos
            $('#btnActualizar').click(function() {
                location.reload();
            });
            
            // Cambio de entidad bancaria actualiza cuentas
            const entidadInicial = $('#cbEntidad').val();
    if (entidadInicial) {
        console.log("Cargando cuentas iniciales para entidad:", entidadInicial);
        // Solo cargar si no hay cuentas preexistentes
        if ($('#cbCuenta option').length <= 1) {
            cargarCuentasPorEntidad(entidadInicial);
        }
    }
    
    // Cambio de entidad bancaria actualiza cuentas
    $('#cbEntidad').change(function() {
        const entidadSeleccionada = $(this).val();
        console.log("Entidad seleccionada:", entidadSeleccionada);
        if (entidadSeleccionada) {
            cargarCuentasPorEntidad(entidadSeleccionada);
        }
    });
});
        
        // Cargar cuentas por entidad
        function cargarCuentasPorEntidad(entidad) {
    console.log("Solicitando cuentas para entidad:", entidad);
    
    // Mostrar indicador de carga en el selector
    const cbCuenta = $('#cbCuenta');
    cbCuenta.prop('disabled', true);
    cbCuenta.html('<option>Cargando cuentas...</option>');
    
    $.ajax({
        url: '/conciliaciones/cuentas-por-entidad',
        type: 'GET',
        data: {
            entidad: entidad
        },
        dataType: 'json', // Especificar que esperamos JSON
        beforeSend: function(xhr) {
            xhr.setRequestHeader(header, token);
        },
        success: function(response) {
            console.log("Respuesta completa:", response);
            
            cbCuenta.empty();
            
            // Verificar si hay respuesta válida
            if (response && Array.isArray(response) && response.length > 0) {
                console.log(`Se encontraron ${response.length} cuentas`);
                
                // Añadir las nuevas opciones
                response.forEach(function(cuenta) {
                    console.log("Cuenta:", cuenta);
                    cbCuenta.append(
                        $('<option>', {
                            value: cuenta.nrocta,
                            text: cuenta.descrip || cuenta.nrocta
                        })
                    );
                });
            } else {
                console.warn("No se recibieron cuentas en la respuesta");
                cbCuenta.append($('<option>', {
                    value: '',
                    text: 'No hay cuentas disponibles'
                }));
            }
            
            cbCuenta.prop('disabled', false);
        },
        error: function(xhr, status, error) {
            console.error("Error al cargar cuentas:", status, error);
            console.error("Detalles del error:", xhr.responseText);
            
            cbCuenta.empty();
            cbCuenta.append($('<option>', {
                value: '',
                text: 'Error al cargar cuentas'
            }));
            cbCuenta.prop('disabled', false);
        }
    });
}
        // Función para cargar archivo
        function uploadFile(file) {
            let formData = new FormData();
            formData.append('file', file);
            formData.append('entidad', $('#cbEntidad').val());
            formData.append('cuenta', $('#cbCuenta').val());
            formData.append('periodo', $('#month').val());
            
            // Mostrar indicador de carga
            const fileLabel = $('label[for="fileInput"]');
            const originalHtml = fileLabel.html();
            fileLabel.html('<i class="fas fa-spinner fa-spin"></i> Cargando archivo...');
            
            $.ajax({
                url: '/conciliaciones/cargar-archivo',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(header, token);
                },
                success: function(response) {
                    if (response.success) {
                        alert('Archivo cargado con éxito. Se importaron ' + response.registros + ' transacciones.');
                        location.reload();
                    } else {
                        alert('Error al cargar el archivo: ' + response.message);
                        fileLabel.html(originalHtml);
                        $('#fileInput').val('');
                        $('#file-upload-name').text('');
                    }
                },
                error: function() {
                    alert('Error en el servidor al procesar el archivo');
                    fileLabel.html(originalHtml);
                    $('#fileInput').val('');
                    $('#file-upload-name').text('');
                }
            });
        }
        
        // Función para procesar conciliación automática
        function procesarConciliacionAutomatica() {
            if (!confirm('¿Está seguro de ejecutar el proceso de conciliación? Esto generará el reporte de comparación entre transacciones bancarias y Navasoft.')) {
                return;
            }
            
            const cuenta = $('#cbCuenta').val();
            // Formatear el periodo correctamente (MMYYYY)
            let periodo = $('#month').val();
            if (!periodo) {
                alert("Por favor seleccione un periodo");
                return;
            }
            
            // Convertir de MM/YYYY a MMYYYY
            periodo = periodo.replace('/', '');
            if (periodo.length === 5) {
                // Agregar un 0 al principio si el mes es de un solo dígito
                periodo = '0' + periodo;
            }
            
            // Mostrar indicador de carga
            const btnProcesar = $('#btnProcesar');
            const originalHtml = btnProcesar.html();
            btnProcesar.html('<i class="fas fa-spinner fa-spin"></i> Procesando...');
            btnProcesar.prop('disabled', true);
            
            // Ejecutar y descargar automáticamente
            $.ajax({
                url: '/conciliaciones/procesar-automatico',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    cuentaBanco: cuenta,
                    periodo: periodo
                }),
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(header, token);
                },
                success: function(response) {
                    console.log("Respuesta del servidor:", response);
                    
                    if (response && response.success) {
                        // Crear un mensaje más visual
                        let mensaje = '<div class="alert alert-success mb-3">' +
                                     '<h5 class="alert-heading">Proceso completado con éxito</h5>' +
                                     '<hr>' +
                                     '<p class="mb-0">El proceso de conciliación ha sido ejecutado correctamente.</p>' +
                                     '<p class="mb-0">Se encontraron ' + (response.totalRegistros || 0) + ' registros en total.</p>' +
                                     '<p class="mb-0 mt-3">¿Desea descargar el reporte de conciliación ahora?</p>' +
                                     '</div>';
                        
                        // Modal para mostrar resultado y ofrecer descarga inmediata
                        const resultModal = $('<div class="modal fade" tabindex="-1">' +
                                            '<div class="modal-dialog">' +
                                            '<div class="modal-content">' +
                                            '<div class="modal-header bg-success text-white">' +
                                            '<h5 class="modal-title">Proceso Completado</h5>' +
                                            '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>' +
                                            '</div>' +
                                            '<div class="modal-body">' + mensaje + '</div>' +
                                            '<div class="modal-footer">' +
                                            '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, más tarde</button>' +
                                            '<button type="button" class="btn btn-primary" id="btnDescargarAhora">Sí, descargar ahora</button>' +
                                            '</div>' +
                                            '</div>' +
                                            '</div>' +
                                            '</div>');
                        
                        resultModal.appendTo('body').modal('show');
                        
                        // Configurar botón de descarga inmediata
                        $('#btnDescargarAhora').click(function() {
                            resultModal.modal('hide');
                            exportarExcel();
                        });
                        
                        // Recargar después de cerrar el modal si no se eligió descargar
                        resultModal.on('hidden.bs.modal', function() {
                            location.reload();
                        });
                    } else {
                        const mensaje = response && response.message ? response.message : 'No se pudo ejecutar el proceso de conciliación';
                        console.error('Error detallado:', response);
                        alert('Error al procesar: ' + mensaje);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error AJAX:', status, error);
                    console.error('Respuesta del servidor:', xhr.responseText);
                    alert('Error en el servidor al procesar la conciliación: ' + error);
                },
                complete: function() {
                    // Restaurar botón original
                    btnProcesar.html(originalHtml);
                    btnProcesar.prop('disabled', false);
                }
            });
        }
        
        // Función para exportar a Excel - Reporte de conciliación completo
        function exportarExcel() {
            const cuenta = $('#cbCuenta').val();
            let periodo = $('#month').val();
            
            if (!periodo) {
                alert("Por favor seleccione un periodo");
                return;
            }
            
            // Mostrar indicador
            const btnExportar = $('#btnExportar');
            const originalHtml = btnExportar.html();
            btnExportar.html('<i class="fas fa-spinner fa-spin"></i> Generando informe...');
            btnExportar.prop('disabled', true);
            
            // Crear URL de descarga
            const url = '/conciliaciones/exportar?cuenta=' + encodeURIComponent(cuenta) + 
                        '&periodo=' + encodeURIComponent(periodo);
            
            // Abrir la URL en una nueva ventana o descargar
            setTimeout(function() {
                window.location.href = '/conciliaciones/exportar?cuenta=' + cuenta + '&periodo=' + periodo.replace('/', '');
                setTimeout(function() {
                    btnExportar.html(originalHtml);
                    btnExportar.prop('disabled', false);
                }, 1000);
            }, 500);
        }
        
        // Función para formatear montos
        function formatearMonto(monto) {
            if (monto === null || monto === undefined) return '';
            return parseFloat(monto).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }
    </script>
</body>
</html>