<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listado de Mercadería en Tránsito | Sudamericana</title>
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

    <!-- Estilos adicionales específicos para esta página -->
    <style>
        .page-title {
            border-left: 5px solid #0d6efd;
            padding-left: 15px;
        }

        .btn-primary,
        .btn-success {
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            border-radius: 8px 8px 0 0;
        }

        .form-label {
            font-weight: 600;
            color: #495057;
        }

        .alert-info {
            border-left: 4px solid #0dcaf0;
        }

        /* Estilo para el botón de exportación */
        .btn-export {
            background-color: #198754;
            color: white;
            padding: 10px 25px;
            transition: all 0.3s;
        }

        .btn-export:hover {
            background-color: #146c43;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Estilo para el navbar personalizado */
        .custom-navbar {
            background-color: #343a40;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .main-content {
            margin-top: 20px;
            padding: 20px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            visibility: hidden;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.05);
        }

        .table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <!-- Overlay de carga -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner-border text-light loading-spinner" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>

    <!-- Navbar -->
    <div th:insert="~{fragments/navbar :: navbar}"></div>

    <div class="container-fluid py-4">
        <!-- Título de la página -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="page-title text-primary">
                <i class="fa-solid fa-truck-fast me-2"></i>
                Listado de Mercadería en Tránsito
            </h2>
            <span class="badge bg-primary fw-normal">Módulo de Importacion</span>
        </div>

        <!-- Tarjeta de Acciones -->
        <div class="card mb-4 shadow">
            <div class="card-header bg-primary text-white py-3">
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-filter me-2"></i>
                    <h5 class="card-title mb-0">Acciones Disponibles</h5>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="d-grid">
                            <button id="generateExcelBtn" class="btn btn-export btn-lg shadow">
                                <i class="fa-solid fa-file-excel me-2"></i>
                                Generar Reporte Excel
                            </button>
                        </div>
                        <div class="form-text text-muted mt-2 text-center">
                            Descarga un reporte completo con todos los registros
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid">
                            <button id="refreshDataBtn" class="btn btn-primary btn-lg shadow">
                                <i class="fa-solid fa-sync-alt me-2"></i>
                                Actualizar Datos
                            </button>
                        </div>
                        <div class="form-text text-muted mt-2 text-center">
                            Actualiza la vista previa con los datos más recientes
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid">
                            <button id="viewDetailsBtn" class="btn btn-info text-white btn-lg shadow">
                                <i class="fa-solid fa-magnifying-glass me-2"></i>
                                Ver Detalles
                            </button>
                        </div>
                        <div class="form-text text-muted mt-2 text-center">
                            Visualiza información detallada de los productos
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tarjeta de Datos -->
        <div class="card shadow">
            <div class="card-header bg-light py-3">
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-table me-2 text-primary"></i>
                    <h5 class="card-title mb-0">Listado de Productos en Tránsito</h5>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr id="headerRow">
                                <th>Código</th>
                                <th>Código Final</th>
                                <th>Marca</th>
                                <th>Descripción</th>
                                <th>Precio Unitario</th>
                                <th>Precio Total</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <i class="fa-solid fa-spinner fa-spin me-2"></i>
                                    Cargando datos, por favor espere...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="text-center py-3 bg-light">
                    <small class="text-muted">
                        <i class="fa-solid fa-info-circle me-1"></i>
                        La vista previa muestra un máximo de 10 registros. Para ver todos los registros, descargue el
                        reporte Excel.
                    </small>
                </div>
            </div>
        </div>

        <!-- Información adicional -->
        <div class="alert alert-info d-flex align-items-center mt-4 shadow-sm">
            <i class="fa-solid fa-circle-info fs-4 me-3"></i>
            <div>
                <h5 class="alert-heading">Información</h5>
                <p class="mb-0">Este módulo muestra la mercadería que está en camino hacia nuestros almacenes.
                    Incluye códigos de producto, cantidad, precio y otros datos importantes para el seguimiento.</p>
            </div>
        </div>

        <!-- Tarjeta de instrucciones -->
        <div class="card mt-4 shadow">
            <div class="card-header bg-light py-3">
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-list-check me-2 text-primary"></i>
                    <h5 class="card-title mb-0">Instrucciones de uso</h5>
                </div>
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li class="mb-2">Haga clic en <strong>Actualizar Datos</strong> para ver la información más reciente
                        sobre la mercadería en tránsito.</li>
                    <li class="mb-2">Use <strong>Generar Reporte Excel</strong> para descargar un informe completo con
                        todos los registros.</li>
                    <li class="mb-2">Seleccione <strong>Ver Detalles</strong> para obtener información adicional sobre
                        los items en tránsito.</li>
                    <li>La información se actualiza automáticamente cuando se registran nuevas compras o ingresos a
                        almacenes.</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white text-center py-3 mt-5">
        <p class="mb-0">&copy; 2025 Sudamericana. Todos los derechos reservados.</p>
    </footer>

    <!-- Bootstrap JS y jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {
            // Variables globales para almacenar datos
            let proveedores = [];
    
            // Función para mostrar el overlay de carga
            function showLoading() {
                $('#loadingOverlay').css('visibility', 'visible');
            }
    
            // Función para ocultar el overlay de carga
            function hideLoading() {
                $('#loadingOverlay').css('visibility', 'hidden');
            }
    
            // Cargar proveedores y datos al iniciar
            cargarProveedoresYDatos();
    
            // Evento para el botón de Excel
            $('#generateExcelBtn').click(function () {
                showLoading();
    
                // Usar fetch para manejar errores
                fetch('/listado-transito/generar-excel')
                    .then(response => {
                        if (response.ok) {
                            // Obtener el nombre del archivo
                            const contentDisposition = response.headers.get('Content-Disposition');
                            let filename = 'ListadoDeTransito.xlsx';
                            if (contentDisposition && contentDisposition.indexOf('attachment') !== -1) {
                                const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                                const matches = filenameRegex.exec(contentDisposition);
                                if (matches != null && matches[1]) {
                                    filename = matches[1].replace(/['"]/g, '');
                                }
                            }
    
                            // Convertir la respuesta a blob
                            return response.blob().then(blob => {
                                // Crear URL del objeto
                                const url = window.URL.createObjectURL(blob);
    
                                // Crear elemento a para la descarga
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = filename;
                                document.body.appendChild(a);
                                a.click();
    
                                // Limpiar
                                window.URL.revokeObjectURL(url);
                                document.body.removeChild(a);
    
                                hideLoading();
                            });
                        } else {
                            console.error('Error al descargar el archivo:', response.statusText);
                            hideLoading();
                            alert('Error al generar el reporte Excel. Por favor, inténtelo de nuevo.');
                        }
                    })
                    .catch(error => {
                        console.error('Error en la solicitud:', error);
                        hideLoading();
                        alert('Error al generar el reporte Excel. Por favor, inténtelo de nuevo.');
                    });
            });
    
            // Evento para actualizar datos
            $('#refreshDataBtn').click(function () {
                // Agregar animación al ícono
                $(this).find('i').addClass('fa-spin');
                setTimeout(() => {
                    $(this).find('i').removeClass('fa-spin');
                }, 1000);
    
                cargarProveedoresYDatos();
            });
    
            // Evento para ver detalles
            $('#viewDetailsBtn').click(function () {
                alert('Esta funcionalidad estará disponible próximamente.');
            });
    
            // Función para cargar proveedores y luego datos
            function cargarProveedoresYDatos() {
                showLoading();
                
                // Primero cargar la lista de proveedores
                $.ajax({
                    url: '/listado-transito/proveedores',
                    method: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        proveedores = data;
                        actualizarEncabezadosTabla();
                        cargarDatos();
                    },
                    error: function (error) {
                        console.error('Error al cargar proveedores:', error);
                        hideLoading();
                        mostrarErrorCarga();
                    }
                });
            }
    
            // Función para actualizar los encabezados de la tabla con los proveedores
            function actualizarEncabezadosTabla() {
                const headerRow = $('#headerRow');
                
                // Limpiar encabezados de proveedores anteriores
                headerRow.find('th.proveedor-header').remove();
                
                // Añadir encabezados de proveedores
                proveedores.forEach(function(proveedor) {
                    headerRow.append(`<th class="proveedor-header">${proveedor}</th>`);
                });
            }
    
            // Función para cargar datos
            function cargarDatos() {
                $.ajax({
                    url: '/listado-transito/datos',
                    method: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        // Limpiar tabla
                        $('#previewTableBody').empty();
    
                        // Si no hay datos
                        if (!data || data.length === 0) {
                            mostrarSinDatos();
                            hideLoading();
                            return;
                        }
    
                        // Mostrar solo los primeros 10 registros
                        const displayData = data.slice(0, 10);
    
                        // Llenar tabla con datos
                        displayData.forEach(function (item) {
                            let row = `<tr>
                                <td>${item.codi || ''}</td>
                                <td>${item.codf || ''}</td>
                                <td>${item.marc || ''}</td>
                                <td>${item.descr || ''}</td>
                                <td class="text-end">${formatCurrency(item.preu) || '$ 0.0000'}</td>
                                <td class="text-end">${formatCurrency(item.tota) || '$ 0.0000'}</td>`;
                                
                            // Añadir columnas de proveedores
                            proveedores.forEach(function(proveedor) {
                                row += `<td class="text-end">${formatQuantity(item[proveedor]) || '0.0000'}</td>`;
                            });
                                
                            row += `</tr>`;
                            $('#previewTableBody').append(row);
                        });
    
                        hideLoading();
                    },
                    error: function (error) {
                        console.error('Error al cargar datos:', error);
                        hideLoading();
                        mostrarErrorCarga();
                    }
                });
            }
    
            function mostrarSinDatos() {
                $('#previewTableBody').html(`
                    <tr>
                        <td colspan="${7 + proveedores.length}" class="text-center py-4">
                            <i class="fa-solid fa-box-open me-2 text-muted" style="font-size: 1.5rem;"></i>
                            <p class="mb-0 text-muted">No se encontraron registros de mercadería en tránsito</p>
                        </td>
                    </tr>
                `);
            }
    
            function mostrarErrorCarga() {
                $('#previewTableBody').html(`
                    <tr>
                        <td colspan="${7 + proveedores.length}" class="text-center py-4">
                            <div class="text-danger">
                                <i class="fa-solid fa-triangle-exclamation me-2" style="font-size: 1.5rem;"></i>
                                <p class="mb-2">Error al cargar los datos</p>
                                <button class="btn btn-sm btn-outline-danger" onclick="window.location.reload()">
                                    <i class="fa-solid fa-rotate me-1"></i>Reintentar
                                </button>
                            </div>
                        </td>
                    </tr>
                `);
            }
    
            // Función para formatear moneda con 4 decimales
            function formatCurrency(value) {
                if (!value) return '$ 0.0000';
                return '$ ' + parseFloat(value).toLocaleString('en-US', {
                    minimumFractionDigits: 4,
                    maximumFractionDigits: 4
                });
            }
    
            // Función para formatear cantidad con 4 decimales
            function formatQuantity(value) {
                if (!value) return '0.0000';
                return parseFloat(value).toLocaleString('es-PE', {
                    minimumFractionDigits: 4,
                    maximumFractionDigits: 4
                });
            }
        });
    </script>
</body>

</html>