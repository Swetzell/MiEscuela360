<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta Masiva Retenedor :: SG - SUDAMERICANA</title>
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Estilos personalizados para finanzas -->
    <style>
        :root {
            --finance-yellow: #FFD700;
            --finance-yellow-dark: #E6C200;
            --finance-text: #333;
        }
        .bg-finance {
            background-color: var(--finance-yellow) !important;
            color: var(--finance-text) !important;
        }
        .btn-finance {
            background-color: var(--finance-yellow);
            border-color: var(--finance-yellow-dark);
            color: var(--finance-text);
        }
        .btn-finance:hover {
            background-color: var(--finance-yellow-dark);
            border-color: var(--finance-yellow-dark);
            color: var(--finance-text);
        }
        .finance-icon {
            color: var(--finance-yellow);
        }
        .card-header.bg-finance h5 {
            font-weight: 600;
        }
        .finance-border {
            border-color: var(--finance-yellow) !important;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-file-upload finance-icon me-2"></i> Consulta Masiva Retenedor
            </h1>
            <div>
                <a href="/retenedores" class="btn btn-finance">
                    <i class="fas fa-search me-2"></i>Consulta Individual
                </a>
                <a href="/retenedores/resultados" class="btn btn-finance">
                    <i class="fas fa-database me-2"></i>Ver Resultados
                </a>
                <a href="/retenedores/historial" class="btn btn-finance">
                    <i class="fas fa-history me-2"></i>Ver Historial
                </a>
            </div>
        </div>

        <!-- Mensajes de alerta -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${param.showProgress}" class="alert alert-info">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm text-warning me-2" role="status">
                    <span class="visually-hidden">Procesando...</span>
                </div>
                <span>
                    <strong>Procesando consulta masiva...</strong> 
                    El proceso puede tardar varios minutos. Los resultados se mostrarán automáticamente 
                    en esta tabla a medida que se vayan procesando.
                </span>
            </div>
        </div>
        <div class="alert alert-info mb-4" th:if="${param.processingMasivo}">
            <div class="d-flex align-items-center">
                <div class="spinner-border text-warning me-3" role="status">
                    <span class="visually-hidden">Procesando...</span>
                </div>
                <div>
                    <h5 class="mb-1">Procesando consulta masiva...</h5>
                    <p class="mb-0">Las consultas se están realizando secuencialmente. Los resultados se irán mostrando 
                    en esta tabla a medida que finalicen. Este proceso puede tardar varios minutos.</p>
                </div>
            </div>
        </div>
        <!-- Formulario de consulta masiva -->
        <div class="card shadow finance-border">
            <div class="card-header bg-finance">
                <h5 class="mb-0"><i class="fas fa-file-upload me-2"></i>Consulta Masiva de RUCs</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs mb-3" id="consultaTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="archivo-tab" data-bs-toggle="tab" 
                                data-bs-target="#archivo-content" type="button" role="tab" 
                                aria-controls="archivo-content" aria-selected="true">
                            <i class="fas fa-file-alt me-2"></i>Desde Archivo
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="bd-tab" data-bs-toggle="tab" 
                                data-bs-target="#bd-content" type="button" role="tab" 
                                aria-controls="bd-content" aria-selected="false">
                            <i class="fas fa-database me-2"></i>Desde Base de Datos
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="consultaTabContent">
                    <!-- Pestaña 1: Desde archivo -->
                    <div class="tab-pane fade show active" id="archivo-content" role="tabpanel" 
                         aria-labelledby="archivo-tab">
                        <form th:action="@{/retenedores/consulta-masiva}" method="post" 
                              enctype="multipart/form-data">
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label for="archivo" class="form-label">Archivo de RUCs</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-finance"><i class="fas fa-file-alt"></i></span>
                                        <input type="file" class="form-control" id="archivo" name="archivo" 
                                               accept=".txt,.csv" required>
                                        <button class="btn btn-finance" type="submit">
                                            <i class="fas fa-upload me-1"></i>Procesar Archivo
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        Suba un archivo de texto con un RUC por línea.
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <p>La consulta masiva procesará cada RUC individualmente utilizando el mismo método 
                                que la consulta individual.</p>
                                <p>Este proceso puede tardar varios minutos. Los resultados se 
                                procesarán en segundo plano y podrá verificarlos en la sección de Resultados.</p>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Pestaña 2: Desde BD -->
                    <div class="tab-pane fade" id="bd-content" role="tabpanel" 
                         aria-labelledby="bd-tab">
                        <form th:action="@{/retenedores/consulta-masiva-bd}" method="post">
                            <div class="alert alert-info mb-4">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Consulta desde Base de Datos:</strong> Esta opción consultará automáticamente 
                                todos los RUCs de clientes registrados en el sistema Navasoft, procesando cada uno 
                                individualmente como si lo hiciera desde la consulta individual.
                            </div>
                            
                            <div class="alert alert-warning mb-4">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Advertencia:</strong> Esta operación puede tomar varios minutos dependiendo 
                                de la cantidad de RUCs. Se procesará en segundo plano con una pausa de 1.5 segundos 
                                entre cada consulta para no sobrecargar la API.
                            </div>
                            
                            <button type="submit" class="btn btn-finance">
                                <i class="fas fa-database me-2"></i>Iniciar Consulta desde BD
                            </button>
                        </form>
                    </div>
                </div>
            </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>