<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados Kardex | Sudamericana</title>
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

    <style>
        .page-title {
            border-left: 5px solid #0d6efd;
            padding-left: 15px;
        }

        .card {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            border-radius: 8px 8px 0 0;
        }

        .btn-back {
            background-color: #6c757d;
            color: white;
            transition: all 0.3s;
        }

        .btn-back:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }

        .btn-view {
            transition: all 0.2s;
        }

        .btn-view:hover {
            transform: scale(1.05);
        }

        .badge-stock {
            font-size: 0.9rem;
            padding: 6px 10px;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <div th:insert="~{fragments/navbar :: navbar}"></div>

    <div class="container-fluid py-4">
        <!-- Título de la página -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="page-title text-primary">
                <i class="fa-solid fa-boxes-stacked me-2"></i>
                Resultados de Búsqueda
            </h2>
            <div>
                <a th:href="@{/kardex}" class="btn btn-back">
                    <i class="fa-solid fa-arrow-left me-2"></i> Volver
                </a>
            </div>
        </div>

        <!-- Criterios de búsqueda -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <strong><i class="fa-solid fa-filter me-2"></i>Filtros aplicados:</strong>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3" th:if="${almacen != null && almacen != ''}">
                        <strong>Almacén:</strong> <span th:text="${almacen}"></span>
                    </div>
                    <div class="col-md-3" th:if="${codigo != null && codigo != ''}">
                        <strong>Código:</strong> <span th:text="${codigo}"></span>
                    </div>
                    <div class="col-md-3" th:if="${descripcion != null && descripcion != ''}">
                        <strong>Descripción:</strong> <span th:text="${descripcion}"></span>
                    </div>
                    <div class="col-md-3" th:if="${linea != null && linea != ''}">
                        <strong>Línea:</strong> <span th:text="${linea}"></span>
                    </div>
                    <div class="col-md-3" th:if="${marca != null && marca != ''}">
                        <strong>Marca:</strong> <span th:text="${marca}"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resultados -->
        <div class="table-responsive">
            <div th:if="${productos.empty}" class="alert alert-info">
                <i class="fa-solid fa-info-circle me-2"></i>
                No se encontraron productos con los criterios de búsqueda especificados.
            </div>
            <table id="productos-table" class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Cod. Nava</th>
                        <th>Código</th>
                        <th>Marca</th>
                        <th>Descripción</th>
                        <th>Stock Físico</th>
                        <th>U.M.</th>
                        <th>Tránsito</th>
                        <th>Consignación</th>
                        <th>Reservado(F)</th>
                        <th>Reservado(P)</th>
                        <th>Disponible</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="producto : ${productos}">
                        <td th:text="${producto.codNava}"></td>
                        <td th:text="${producto.producto}"></td>
                        <td th:text="${producto.marca}"></td>
                        <td th:text="${producto.descripcion}"></td>
                        <td class="text-end">
                            <span th:text="${#numbers.formatDecimal(producto.stockFisico, 1, 2)}"
                                class="badge bg-info"></span>
                        </td>
                        <td th:text="${producto.unidadMedida}"></td>
                        <td class="text-end">
                            <span th:text="${#numbers.formatDecimal(producto.stockTransi, 1, 2)}"
                                class="badge bg-warning"></span>
                        </td>
                        <td class="text-end">
                            <span th:text="${#numbers.formatDecimal(producto.stockConsig, 1, 2)}"
                                class="badge bg-secondary"></span>
                        </td>
                        <td class="text-end">
                            <span th:text="${#numbers.formatDecimal(producto.stockReserF, 1, 2)}"
                                class="badge bg-danger"></span>
                        </td>
                        <td class="text-end">
                            <span th:text="${#numbers.formatDecimal(producto.stockReserP, 1, 2)}"
                                class="badge bg-warning"></span>
                        </td>
                        <td class="text-end">
                            <span th:text="${#numbers.formatDecimal(producto.stockDispon, 1, 2)}"
                                th:class="${producto.stockDispon > 0 ? 'badge bg-success' : 'badge bg-danger'}"></span>
                        </td>
                        <td>
                            <a th:href="@{'/kardex/detalle/' + ${producto.producto}}" class="btn btn-primary btn-sm">
                                <i class="fa-solid fa-eye"></i> Ver
                            </a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    </div>
    </div>

    <!-- jQuery y Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

    <script>
       $(document).ready(function () {
    $('#productos-table').DataTable({
        responsive: true,
        language: {
            url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
        },
        processing: true,
        serverSide: true,
        pageLength: 30,
        lengthMenu: [[30], [30]], // Forzar 30 registros por página
        ajax: {
            url: '/kardex/api/productos',
            type: 'GET',
            data: function(d) {
                return {
                    page: Math.ceil(d.start / d.length) + 1,
                    size: d.length,
                    almacen: $('#almacen').val() || '',
                    codigo: $('#codigo').val() || '',
                    descripcion: $('#descripcion').val() || '',
                    linea: $('#linea').val() || '',
                    marca: $('#marca').val() || ''
                };
            }
        },
        columns: [
            { data: 'codNava' },
            { data: 'producto' },
            { data: 'marca' },
            { data: 'descripcion' },
            { 
            data: 'stockFisico',
            render: function(data) {
                return `<span class="badge bg-info">${parseFloat(data).toLocaleString('es-PE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
                })}</span>`;
            }
            },
            { data: 'unidadMedida' },
            { 
            data: 'stockTransi',
            render: function(data) {
                return `<span class="badge bg-warning">${parseFloat(data).toLocaleString('es-PE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
                })}</span>`;
            }
            },
            { 
            data: 'stockConsig',
            render: function(data) {
                return `<span class="badge bg-secondary">${parseFloat(data).toLocaleString('es-PE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
                })}</span>`;
            }
            },
            { 
            data: 'stockReserF',
            render: function(data) {
                return `<span class="badge bg-danger">${parseFloat(data).toLocaleString('es-PE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
                })}</span>`;
            }
            },
            { 
            data: 'stockReserP',
            render: function(data) {
                return `<span class="badge bg-warning">${parseFloat(data).toLocaleString('es-PE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
                })}</span>`;
            }
            },
            { 
            data: 'stockDispon',
            render: function(data) {
                const badgeClass = parseFloat(data) > 0 ? 'bg-success' : 'bg-danger';
                return `<span class="badge ${badgeClass}">${parseFloat(data).toLocaleString('es-PE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
                })}</span>`;
            }
            },
            { 
            data: 'acciones',
            orderable: false,
            render: function(data, type, row) {
                return `<a href="/kardex/detalle/${row.producto}" class="btn btn-primary btn-sm">
                    <i class="fa-solid fa-eye"></i> Ver
                    </a>`;
            }
            }
        ],
        order: [[1, 'asc']],
        scrollY: '60vh',
        scrollCollapse: true,
        dom: '<"top"i>rt<"bottom"p><"clear">'
    });
});
$(document).ready(function () {
    $('#productos-table').DataTable({
        responsive: true,
        language: {
            url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
        },
        pageLength: 30,
        lengthMenu: [[30], [30]], // Forzar 30 registros por página
        columnDefs: [
            {
                // Numeric columns
                targets: [4, 6, 7, 8, 9, 10],
                className: 'text-end',
                render: function (data, type, row) {
                    if (type === 'display') {
                        return parseFloat(data).toLocaleString('es-PE', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    }
                    return data;
                }
            }
        ],
        order: [[1, 'asc']], // Order by código
        scrollY: '60vh',
        scrollCollapse: true,
        destroy: true // Permite reinicializar la tabla
    });
});
    </script>
</body>

</html>