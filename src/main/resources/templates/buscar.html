<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buscar Productos | Sudamericana</title>
  <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body {
      background-color: #f8f9fa;
    }
    
    .container {
      max-width: 1200px;
    }
    
    /* Estilos adaptados del diseño de formulario.html */
    .page-title {
      border-left: 5px solid #0d6efd;
      padding-left: 15px;
    }
    
    .btn-primary, .btn-success {
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .card {
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }
    
    .card-header {
      border-radius: 8px 8px 0 0;
    }
    
    .form-label {
      font-weight: 600;
      color: #495057;
    }
    
    .alert-info {
      border-left: 4px solid #0dcaf0;
    }
    
    .btn-export {
      background-color: #198754;
      color: white;
      padding: 10px 25px;
      transition: all 0.3s;
    }
    
    .btn-export:hover {
      background-color: #146c43;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    /* Paginación mejorada */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 5px;
      padding: 0;
    }
    
    .pagination .page-item {
      display: inline-block;
    }
    
    .pagination .page-link {
      padding: 8px 14px;
      font-size: 0.95rem;
      border-radius: 5px;
      color: #0d6efd;
      border: 1px solid #dee2e6;
      transition: all 0.2s;
    }
    
    .pagination .page-item.active .page-link {
      background-color: #0d6efd;
      color: #fff;
      border-color: #0d6efd;
      font-weight: 600;
    }
    
    .pagination .page-link:hover {
      color: #0a58ca;
      background-color: #e9ecef;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Sugerencias de búsqueda */
    .list-group-item {
      cursor: pointer;
      transition: all 0.15s ease-in-out;
    }
    
    .list-group-item:hover {
      background-color: #f8f9fa;
    }
    
    .list-group-item.active {
      background-color: #e9ecef;
      border-color: #dee2e6;
      color: #212529;
      font-weight: 500;
    }
    
    .bg-warning {
      background-color: #ffe066 !important;
      padding: 2px;
      border-radius: 2px;
    }
    
    /* Mejoras visuales para la tabla */
    .table {
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .table thead.table-dark th {
      background-color: #343a40;
      border-color: #454d55;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      font-size: 0.8rem;
      padding: 12px;
    }
    
    .table tbody td {
      padding: 10px 12px;
      vertical-align: middle;
    }
    
    /* Botones de acción */
    .btn-sm {
      border-radius: 5px;
      text-transform: none;
      letter-spacing: normal;
      font-weight: 500;
      padding: 5px 10px;
    }
    
    /* Mejoras para los modales */
    .modal-content {
      border-radius: 10px;
      border: none;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    
    .modal-header {
      background-color: #f8f9fa;
      border-radius: 10px 10px 0 0;
      border-bottom: 1px solid #dee2e6;
    }
    
    .modal-footer {
      background-color: #f8f9fa;
      border-top: 1px solid #dee2e6;
      border-radius: 0 0 10px 10px;
    }
    
    /* Mejoras para el formulario de carga y exportación */
    #formUpload, #exportForm {
      margin-bottom: 0;
    }
    
    #loading {
      display: none;
      text-align: center;
      margin-top: 15px;
    }
    
    #mensaje {
      text-align: center;
      margin-top: 15px;
      font-weight: 600;
    }
  </style>
  <meta name="_csrf" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>

<body>
  <div th:insert="~{fragments/navbar :: navbar}"></div>

  <div class="container-fluid py-4">
    <!-- Título de la página -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="page-title text-primary">
        <i class="fa-solid fa-search me-2"></i>
        Gestión de Productos
      </h2>
      <span class="badge bg-primary fw-normal">Módulo de Importacion</span>
    </div>

    <div class="row mb-4">
      <!-- Importar -->
      <div class="col-md-6" >
        <div class="card shadow">
          <div class="card-header bg-primary text-white py-3">
            <div class="d-flex align-items-center">
              <i class="fa-solid fa-file-import me-2"></i>
              <h5 class="card-title mb-0">Importar Excel</h5>
            </div>
          </div>
          <div class="card-body p-4">
            <form id="formUpload" enctype="multipart/form-data">
              <div class="input-group shadow-sm">
                <input type="file" name="file" id="fileInput" class="form-control form-control-lg" required>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-upload me-2"></i>
                  Importar
                </button>
              </div>
            </form>
            <div id="loading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
            </div>
            <p id="mensaje" class="mt-3"></p>
          </div>
        </div>
      </div>

      <!-- Exportar -->
      <div class="col-md-6">
        <div class="card shadow">
          <div class="card-header bg-success text-white py-3">
            <div class="d-flex align-items-center">
              <i class="fa-solid fa-file-export me-2"></i>
              <h5 class="card-title mb-0">Exportar Productos</h5>
            </div>
          </div>
          <div class="card-body p-4">
            <form id="exportForm" th:action="@{/excel/exportar}" method="get" class="row g-3">
              <div class="col-md-5">
                <label for="fechaInicio" class="form-label">Fecha inicio:</label>
                <input type="date" id="fechaInicio" name="fechaInicio" class="form-control shadow-sm" required>
              </div>
              <div class="col-md-5">
                <label for="fechaFin" class="form-label">Fecha fin:</label>
                <input type="date" id="fechaFin" name="fechaFin" class="form-control shadow-sm" required>
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-export w-100">
                  <i class="fas fa-download me-2"></i> Exportar
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

  <!-- Búsqueda -->
<div class="card shadow mb-4">
  <div class="card-header bg-primary text-white py-3">
    <div class="d-flex align-items-center">
      <i class="fa-solid fa-search me-2"></i>
      <h5 class="card-title mb-0">Buscar Productos</h5>
    </div>
  </div>
  <div class="card-body p-4">
    <form th:action="@{/excel/buscar}" method="get" class="row g-2">
      <div class="col-md-10 position-relative">
        <div class="input-group shadow-sm">
          <span class="input-group-text bg-primary text-white">
            <i class="fas fa-search"></i>
          </span>
          <input type="text" id="codigo" name="codigo" class="form-control form-control-lg" 
               th:value="${codigo}" placeholder="Buscar por código, marca o proveedor..." 
               autocomplete="off">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-search me-1"></i> Buscar
          </button>
          <!-- Botón de limpiar más pequeño y dentro del input-group -->
            <a href="/excel/buscar" class="btn btn-outline-secondary">
              <i class="fas fa-eraser"></i>
            </a>
        </div>
        <div id="suggestions" class="list-group position-absolute w-100 shadow-lg" 
             style="z-index: 1000; max-height: 300px; overflow-y: auto; top: 100%;"></div>
        <small class="form-text text-muted mt-2">
          <i class="fas fa-info-circle me-1"></i>
          La búsqueda ignora mayúsculas, espacios y símbolos. Escriba al menos 2 caracteres para ver sugerencias.
        </small>
      </div>
    </form>
  </div>
</div>

    <!-- Resultados -->
    <div th:if="${productos != null}" class="card shadow p-0">
      <div class="card-header bg-light py-3">
        <div class="d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <i class="fa-solid fa-table me-2 text-primary"></i>
            <h5 class="card-title mb-0">Resultados</h5>
          </div>
          <!-- Botón de refrescar -->
          <button class="btn btn-outline-primary shadow-sm" onclick="location.reload();">
            <i class="fas fa-sync-alt me-1"></i> Refrescar
          </button>
        </div>
      </div>
      <div class="card-body p-4">
        <div class="table-responsive">
          <table class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>Código</th>
                <th>Marca</th>
                <th>Stock</th>
                <th>Precio (US$)</th>
                <th>Proveedor</th>
                <th>Pais</th>
                <th>Fecha</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr th:if="${productos.empty}">
                <td colspan="8" class="text-center py-4">
                  <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i> No se encontraron productos
                  </div>
                </td>
              </tr>
              <tr th:each="producto : ${productos.content}" th:unless="${productos.empty}">
                <td th:text="${producto.codigo}"></td>
                <td th:text="${producto.marca}"></td>
                <td th:text="${producto.stock}"></td>
                <td th:text="${#numbers.formatDecimal(producto.precio, 1, 3)}"></td>
                <td th:text="${producto.proveedor}"></td>
                <td th:text="${producto.pais != null && !producto.pais.isEmpty() ? producto.pais : 'N/A'}"></td>
                <td th:text="${#dates.format(producto.fechaCreacion, 'dd-MM-yyyy')}"></td>
                <td>
                  <div class="btn-group">
                    <button class="btn btn-sm btn-primary edit-btn" th:data-id="${producto.id}" 
                         th:data-codigo="${producto.codigo}" th:data-marca="${producto.marca}"
                         th:data-stock="${producto.stock}" th:data-precio="${producto.precio}"
                         th:data-proveedor="${producto.proveedor}" th:data-pais="${producto.pais}"
                         th:data-fecha="${producto.fechaCreacion}">
                      <i class="fas fa-edit me-1"></i> Editar
                    </button>
                    <button class="btn btn-sm btn-danger delete-btn" th:data-id="${producto.id}">
                      <i class="fas fa-trash me-1"></i> Eliminar
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Paginación -->
        <div class="d-flex justify-content-center mt-4">
          <nav aria-label="Navegación de páginas">
            <ul class="pagination">
              <li class="page-item" th:classappend="${productos.first} ? 'disabled'">
                <a class="page-link"
                  th:href="@{/excel/buscar(codigo=${codigo}, page=${productos.number - 1}, size=10)}" aria-label="Anterior">
                  <i class="fas fa-chevron-left"></i>
                </a>
              </li>
              <li class="page-item" th:each="i : ${#numbers.sequence(
                    T(java.lang.Math).max(1, productos.number - 2),
                    T(java.lang.Math).min(productos.totalPages, productos.number + 3)
                )}" th:classappend="${productos.number + 1 == i} ? 'active'">
                <a class="page-link" th:href="@{/excel/buscar(codigo=${codigo}, page=${i - 1}, size=10)}"
                  th:text="${i}"></a>
              </li>
              <li class="page-item" th:classappend="${productos.last} ? 'disabled'">
                <a class="page-link"
                  th:href="@{/excel/buscar(codigo=${codigo}, page=${productos.number + 1}, size=10)}" aria-label="Siguiente">
                  <i class="fas fa-chevron-right"></i>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>

    <!-- Modal para editar producto -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">
              <i class="fas fa-edit me-2 text-primary"></i>
              Editar Producto
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editForm">
              <input type="hidden" id="editId">
              <div class="mb-3">
                <label for="editCodigo" class="form-label">Código</label>
                <input type="text" class="form-control" id="editCodigo" required>
              </div>
              <div class="mb-3">
                <label for="editMarca" class="form-label">Marca</label>
                <input type="text" class="form-control" id="editMarca" required>
              </div>
              <div class="mb-3">
                <label for="editStock" class="form-label">Stock</label>
                <input type="number" class="form-control" id="editStock" min="0" step="1" required>
              </div>
              <div class="mb-3">
                <label for="editPrecio" class="form-label">Precio (US$)</label>
                <input type="number" 
                       class="form-control" 
                       id="editPrecio" 
                       min="0" 
                       step="0.001" 
                       required
                       onchange="this.value = parseFloat(this.value).toFixed(4)">
            </div>
              <div class="mb-3">
                <label for="editProveedor" class="form-label">Proveedor</label>
                <input type="text" class="form-control" id="editProveedor" required>
              </div>
              <div class="mb-3">
                <label for="editPais" class="form-label">País</label>
                <input type="text" class="form-control" id="editPais">
              </div>
              <div class="mb-3">
                <label for="editFecha" class="form-label">Fecha</label>
                <input type="text" class="form-control" id="editFecha" disabled>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-1"></i> Cancelar
            </button>
            <button type="button" class="btn btn-primary" id="saveEditBtn">
              <i class="fas fa-save me-1"></i> Guardar Cambios
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de confirmación para eliminar -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="deleteModalLabel">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Confirmar Eliminación
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-circle me-2"></i>
              ¿Está seguro de que desea eliminar este producto? Esta acción no se puede deshacer.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-1"></i> Cancelar
            </button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
              <i class="fas fa-trash me-1"></i> Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
   <!-- Footer -->
   <footer class="bg-dark text-white text-center py-3 mt-5">
    <p class="mb-0">&copy; 2025 Sudamericana. Todos los derechos reservados.</p>
</footer>
    <script>
      document.getElementById("formUpload").addEventListener("submit", function (event) {
  event.preventDefault();
  let formData = new FormData();
  let fileInput = document.getElementById("fileInput");
  let mensaje = document.getElementById("mensaje");
  let loading = document.getElementById("loading");
  
  if (fileInput.files.length === 0) {
    mensaje.innerText = "Por favor, selecciona un archivo.";
    mensaje.style.color = "red";
    return;
  }
  
  const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
  const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
  
  formData.append("file", fileInput.files[0]);
  mensaje.innerText = "";
  mensaje.style.color = "black";
  loading.style.display = "block";
  
  fetch("/excel/upload", {
    method: "POST",
    headers: {
      [csrfHeader]: csrfToken
    },
    body: formData
  })
  .then(response => response.text())
  .then(data => {
    loading.style.display = "none";
    mensaje.innerText = data;
    mensaje.style.color = "green";
    fileInput.value = "";
  })
  .catch(error => {
    loading.style.display = "none";
    mensaje.innerText = "Error al subir el archivo.";
    mensaje.style.color = "red";
    console.error(error);
  });
});

      document.getElementById("exportForm").addEventListener("submit", function (event) {
        event.preventDefault();
        let fechaInicio = document.getElementById("fechaInicio").value;
        let fechaFin = document.getElementById("fechaFin").value;
        if (fechaInicio && fechaFin) {
          window.location.href = `/excel/exportar?fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`;
        } else {
          alert("Por favor, selecciona ambas fechas.");
        }
      });

      document.addEventListener('DOMContentLoaded', function() {
  const codigoInput = document.getElementById('codigo');
  const suggestionsContainer = document.getElementById('suggestions');
  let searchTimeout = null;

  function filterLastByProvider() {
    const tableBody = document.querySelector('table tbody');
    if (!tableBody) return;

    const rows = Array.from(tableBody.querySelectorAll('tr'));
    if (rows.length <= 1) return;

    const latestByProvider = new Map();

    rows.forEach(row => {
      if (row.cells.length < 7) return;
      
      const codigo = row.cells[0].textContent;
      const marca = row.cells[1].textContent;
      const stock = row.cells[2].textContent;
      const precio = row.cells[3].textContent;
      const proveedor = row.cells[4].textContent;
      const fecha = row.cells[6].textContent;

      const key = `${codigo}-${marca}-${precio}-${proveedor}`;
      
      if (!latestByProvider.has(key) || 
          compareDates(fecha, latestByProvider.get(key).fecha) > 0) {
        latestByProvider.set(key, {
          row: row,
          fecha: fecha
        });
      } else {
        row.style.display = 'none';
      }
    });
  }

  function compareDates(date1, date2) {
    const [day1, month1, year1] = date1.split('-').map(Number);
    const [day2, month2, year2] = date2.split('-').map(Number);
    
    const d1 = new Date(year1, month1 - 1, day1);
    const d2 = new Date(year2, month2 - 1, day2);
    
    return d1 - d2;
  }

  filterLastByProvider();

  function updateSuggestions(query) {
  if (searchTimeout) {
    clearTimeout(searchTimeout);
  }

  searchTimeout = setTimeout(() => {
    if (query.length >= 2) {
      fetch(`/excel/sugerencias?codigo=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          suggestionsContainer.innerHTML = '';
          
          if (data.length > 0) {
            data.forEach(suggestion => {
              const suggestionItem = document.createElement('a');
              suggestionItem.href = '#';
              suggestionItem.className = 'list-group-item list-group-item-action py-2';
              
              // Mejor resaltador que maneja códigos con espacios
              let highlightedText = suggestion;
              let queryTerms = query.toLowerCase().split(/\s+/);
              
              queryTerms.forEach(term => {
                if (term.length >= 1) {
                  const regex = new RegExp(`(${escapeRegExp(term)})`, 'gi');
                  highlightedText = highlightedText.replace(regex, '<strong class="bg-warning">$1</strong>');
                }
              });
              
              // Manejar también el caso sin espacios
              const queryNoSpaces = query.toLowerCase().replace(/\s+/g, '');
              if (queryNoSpaces.length >= 2) {
                // Buscar fragmentos del código que coincidan con la consulta sin espacios
                const suggestionNoSpaces = suggestion.toLowerCase().replace(/\s+/g, '');
                let lastIndex = 0;
                let result = '';
                
                for (let i = 0; i < suggestion.length; i++) {
                  const charNoSpace = suggestion[i].toLowerCase().replace(/\s+/, '');
                  const substrNoSpaces = suggestionNoSpaces.substring(lastIndex, lastIndex + queryNoSpaces.length);
                  
                  if (substrNoSpaces === queryNoSpaces) {
                    // Coincidencia encontrada, resaltar caracteres
                    for (let j = 0; j < queryNoSpaces.length; j++) {
                      if (i+j < suggestion.length) {
                        result += `<strong class="bg-warning">${suggestion[i+j]}</strong>`;
                      }
                    }
                    i += queryNoSpaces.length - 1;
                    lastIndex += queryNoSpaces.length;
                  } else {
                    result += suggestion[i];
                    if (charNoSpace !== '') lastIndex++;
                  }
                }
                
                if (result) highlightedText = result;
              }
              
              suggestionItem.innerHTML = `
                <div class="d-flex align-items-center">
                  <i class="fas fa-tag me-2 text-secondary"></i>
                  <span>${highlightedText}</span>
                </div>
              `;
              
              suggestionItem.addEventListener('click', function(e) {
                e.preventDefault();
                codigoInput.value = suggestion;
                suggestionsContainer.innerHTML = '';
                // Enviar el formulario
                codigoInput.closest('form').submit();
              });
              
              suggestionsContainer.appendChild(suggestionItem);
            });
          } else if (query.length >= 2) {
            const noResults = document.createElement('div');
            noResults.className = 'list-group-item text-center py-2 text-muted';
            noResults.innerHTML = `
              <i class="fas fa-search me-2"></i>
              No se encontraron coincidencias para "${query}"
            `;
            suggestionsContainer.appendChild(noResults);
          }
        })
        .catch(error => {
          console.error('Error obteniendo sugerencias:', error);
        });
    } else {
      suggestionsContainer.innerHTML = '';
    }
  }, 300);
}
  // Evento para el campo de búsqueda
  codigoInput.addEventListener('input', function() {
    updateSuggestions(this.value.trim());
  });
  
  // Manejar teclas de navegación
  codigoInput.addEventListener('keydown', function(e) {
    const items = suggestionsContainer.querySelectorAll('a');
    const activeItem = suggestionsContainer.querySelector('a.active');
    
    if (items.length > 0) {
      // Tecla flecha abajo
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (!activeItem) {
          // No hay item activo, activar el primero
          items[0].classList.add('active');
        } else {
          // Hay item activo, pasar al siguiente
          const nextIndex = Array.from(items).indexOf(activeItem) + 1;
          if (nextIndex < items.length) {
            activeItem.classList.remove('active');
            items[nextIndex].classList.add('active');
          }
        }
      }
      
      // Tecla flecha arriba
      else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (activeItem) {
          const prevIndex = Array.from(items).indexOf(activeItem) - 1;
          activeItem.classList.remove('active');
          if (prevIndex >= 0) {
            items[prevIndex].classList.add('active');
          }
        }
      }
      
      // Tecla Enter cuando hay un item activo
      else if (e.key === 'Enter' && activeItem) {
        e.preventDefault();
        activeItem.click();
      }
    }
  });

  // Cerrar sugerencias al hacer click fuera
  document.addEventListener('click', function(e) {
    if (!e.target.closest('#codigo') && !e.target.closest('#suggestions')) {
      suggestionsContainer.innerHTML = '';
    }
  });

  // Función para escapar caracteres especiales en regex
  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  // Si ya hay un valor en el campo al cargar, mostrar sugerencias
  if (codigoInput.value.trim().length >= 2) {
    updateSuggestions(codigoInput.value.trim());
  }
});
document.addEventListener('click', function(e) {
  if (e.target.closest('.edit-btn')) {
    const button = e.target.closest('.edit-btn');
    const id = button.getAttribute('data-id');
    const codigo = button.getAttribute('data-codigo');
    const marca = button.getAttribute('data-marca');
    const stock = button.getAttribute('data-stock');
    const precio = button.getAttribute('data-precio');
    const proveedor = button.getAttribute('data-proveedor');
    const pais = button.getAttribute('data-pais');
    const fecha = button.getAttribute('data-fecha');

    let fechaFormateada = '';
    if (fecha) {
      try {
        let fechaObj;
        
        if (fecha.includes('-')) {
          const [year, month, day] = fecha.split('-');
          fechaObj = new Date(year, month-1, day);
        } else if (fecha.includes('/')) {
          const [day, month, year] = fecha.split('/');
          fechaObj = new Date(year, month-1, day);
        } else {
          fechaObj = new Date(fecha);
        }
        
        if (isNaN(fechaObj.getTime())) {
          throw new Error("Fecha inválida");
        }
        
        const dia = String(fechaObj.getDate()).padStart(2, '0');
        const mes = String(fechaObj.getMonth() + 1).padStart(2, '0');
        const anio = fechaObj.getFullYear();
        fechaFormateada = `${dia}-${mes}-${anio}`;
      } catch(e) {
        console.error('Error al formatear fecha:', e, 'Fecha original:', fecha);
        fechaFormateada = fecha;
      }
    }
    
    document.getElementById('editId').value = id;
    document.getElementById('editCodigo').value = codigo;
    document.getElementById('editMarca').value = marca;
    document.getElementById('editStock').value = stock;
    document.getElementById('editPrecio').value = precio;
    document.getElementById('editProveedor').value = proveedor;
    document.getElementById('editPais').value = pais || '';
    document.getElementById('editFecha').value = fechaFormateada;
    
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
    editModal.show();
  }
  
  if (e.target.closest('.delete-btn')) {
    const button = e.target.closest('.delete-btn');
    const id = button.getAttribute('data-id');
    document.getElementById('confirmDeleteBtn').setAttribute('data-id', id);
    
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
  }
});
const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
document.getElementById('saveEditBtn').addEventListener('click', function() {
  const id = document.getElementById('editId').value;
  const producto = {
    id: id,
    codigo: document.getElementById('editCodigo').value,
    marca: document.getElementById('editMarca').value,
    stock: parseInt(document.getElementById('editStock').value),
    precio: parseFloat(parseFloat(document.getElementById('editPrecio').value).toFixed(3)),
    proveedor: document.getElementById('editProveedor').value,
    pais: document.getElementById('editPais').value || 'N/A'
  };
  
  fetch('/excel/productos/' + id, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      [csrfHeader]: csrfToken
    },
    body: JSON.stringify(producto)
  })
  .then(response => {
    if (!response.ok) {
      return response.text().then(text => { throw new Error(text || 'Error al actualizar') });
    }
    return response.text();
  })
  .then(data => {
    const editModal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
    editModal.hide();
    
    alert('Producto actualizado correctamente');
    
    location.reload();
  })
  .catch(error => {
    console.error('Error completo:', error);
    alert('Error: ' + error.message);
  });
});

document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
  const id = this.getAttribute('data-id');
  
  fetch('/excel/productos/' + id, {
    method: 'DELETE',
    headers: {
        [csrfHeader]: csrfToken
      }
  })
  .then(response => {
    if (!response.ok) {
      return response.text().then(text => { throw new Error(text || 'Error al eliminar') });
    }
    return response.text();
  })
  .then(data => {
    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
    deleteModal.hide();
    
    alert('Producto eliminado correctamente');
    
    location.reload();
  })
  .catch(error => {
    console.error('Error completo:', error);
    alert('Error: ' + error.message);
  });
});
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>